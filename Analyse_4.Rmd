---
title: "R Notebook"
output: html_notebook
---

TO-DO:

MONTAG:
1. adjust ErwerbAbsc -> dyplr --- OK
2. merge SO  --- OK
3. merge all --- OK
4. create controll variables --- OK
5. merge SO and BKA --- OK
6. redo the diagrammes -- OK
7. do the analysis -- !!!!!
8. Präventiv - Theo -- !!!!!
9. Definition from Variables - Theo -- !!!!!

DIENSTAG: 
1. do the problems 
2. Theorie and Hypothesis

MITTWOCH
1. Theorie and Hypothesis

DONNERSTAG
1. Presi

FREITAG: 
1. DBS

SAMSTAG:
1. mathe

# 1. Packages

```{r}
library("tidyverse")
library("haven")
library("dplyr")
library("readxl")
library("plyr")
library("ggplot2")
library("reshape2")
library("stringi")
library("Synth")
```

# 2. Import, adjust and create dataframes
In this section, the data tables from BKA and GESIS are imported and adjusted to create dataframes. 

The LSO and LF dataframes are intended to be used for descriptive statistics and experimental analysis since they are in a long format.  
Dataframes SO and BKA are meant to be merged and used for analysis - hypothesis testing, since they are in a wide format with the two main variable "Jahr" and "Bundesland"

### 2.1 import BKA tables

```{r}

LF2013 <- read_excel("2013_LF.xlsx")
LF2014 <- read_excel("2014_LF.xlsx")
LF2015 <- read_excel("2015_LF.xlsx")
LF2016 <- read_excel("2016_LF.xlsx")
LF2017 <- read_excel("2017_LF.xlsx")
LF2018 <- read_excel("2018_LF.xlsx")
LF2019 <- read_excel("2019_LF.xlsx")
LF2020 <- read_excel("2020_LF.xlsx")

```


### 2.2 adjust BKA tables

```{r}

#create new column 
### This colum specify the year
LF2013["Jahr"] <- 2013
LF2014["Jahr"] <- 2014
LF2015["Jahr"] <- 2015
LF2016["Jahr"] <- 2016
LF2017["Jahr"] <- 2017
LF2018["Jahr"] <- 2018
LF2019["Jahr"] <- 2019
LF2020["Jahr"] <- 2020


# rename variable´s values
### rename the variable´s values in order to have the same name "Deut" instead of "Bund echte Zählung der Tatverdächtigen" or "Bundesrepublik Deutschland"
LF2013$Bundesland <- ifelse(LF2013$Bundesland == "Bund echte Zählung der Tatverdächtigen" |LF2013$Bundesland == "Bundesrepublik Deutschland", "Deut", LF2013$Bundesland )
LF2014$Bundesland <- ifelse(LF2014$Bundesland == "Bund echte Zählung der Tatverdächtigen" |LF2014$Bundesland == "Bundesrepublik Deutschland", "Deut", LF2014$Bundesland )
LF2015$Bundesland <- ifelse(LF2015$Bundesland == "Bund echte Zählung der Tatverdächtigen" |LF2015$Bundesland == "Bundesrepublik Deutschland", "Deut", LF2015$Bundesland )
LF2016$Bundesland <- ifelse(LF2016$Bundesland == "Bund echte Zählung der Tatverdächtigen" |LF2016$Bundesland == "Bundesrepublik Deutschland", "Deut", LF2016$Bundesland )
LF2017$Bundesland <- ifelse(LF2017$Bundesland == "Bund echte Zählung der Tatverdächtigen" |LF2017$Bundesland == "Bundesrepublik Deutschland", "Deut", LF2017$Bundesland )
LF2018$Bundesland <- ifelse(LF2018$Bundesland == "Bund echte Zählung der Tatverdächtigen" |LF2018$Bundesland == "Bundesrepublik Deutschland", "Deut", LF2018$Bundesland )
LF2019$Bundesland <- ifelse(LF2019$Bundesland == "Bund echte Zählung der Tatverdächtigen" |LF2019$Bundesland == "Bundesrepublik Deutschland", "Deut", LF2019$Bundesland )
LF2020$Bundesland <- ifelse(LF2020$Bundesland == "Bund echte Zählung der Tatverdächtigen" |LF2020$Bundesland == "Bundesrepublik Deutschland", "Deut", LF2020$Bundesland )

```


### 2.3 merge BKA tables into Dataframe "LF" for Deskriptive Statistik 

```{r}
# create new dataframe by merging the dataframes of the BKA Databank
### we use this table to build the descriptive statistics, since it is in a long format
LF <- plyr::rbind.fill(LF2013, LF2014, LF2015,LF2016, LF2017, LF2018,LF2019, LF2020 )
```

### 2.4 adjust Dataframe "LF" for Deskriptive Statistik 

```{r}

# create a new variable:
### give every Bundesland a class (1,2,3,4) according to when they made the policy reform (1=2018, 2=2019, 3=2020, 4=2021 or never) according to excel-file Länder-Gesetze
unique(LF$Bundesland)
LF["TG_KG"] <- NA
LF$TG_KG <- ifelse(LF$Bundesland == "Bayern",
                   "0", LF$TG_KG )
LF$TG_KG <- ifelse(LF$Bundesland == "Hessen"|
                   LF$Bundesland == "Nordrhein-Westfalen"|
                   LF$Bundesland == "Sachsen"|
                   LF$Bundesland == "Sachsen-Anhalt",
                   "1", LF$TG_KG )
LF$TG_KG <- ifelse(LF$Bundesland == "Brandenburg"|
                   LF$Bundesland == "Hamburg"|
                   LF$Bundesland == "Niedersachsen",
                   "2", LF$TG_KG )
LF$TG_KG <- ifelse(LF$Bundesland == "Baden-Württemberg"|
                   LF$Bundesland == "Bremen"|
                   LF$Bundesland == "Mecklenburg-Vorpommern"|
                   LF$Bundesland == "Rheinland-Pfalz"|
                   LF$Bundesland == "Saarland",
                   "3", LF$TG_KG )
LF$TG_KG <- ifelse(LF$Bundesland == "Thüringen"|
                   LF$Bundesland == "Schleswig-Holstein"|
                   LF$Bundesland == "Berlin",
                   "4", LF$TG_KG )


# create new variable: 
### regroup the Straftaten according to Interpretationshilfe-BKA
LF["StraftatGruppe"] <- NA
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "-", "Straft insg", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "0", "Straft gg Leben", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "1", "Straft gg sexuelle Selbstbest", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "2", "Straft gg pers Freiheit", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "3", "Diebstahl", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "4", "Diebstahl", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "*", "Diebstahl", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "5", "Vermögens- und Fälschungsdelikte", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "6", "Sonstige Straftatbestände", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "7", "Strafrechtliche Nebengesetze", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "8", "Strafrechtliche Nebengesetze", LF$StraftatGruppe )
LF$StraftatGruppe <- ifelse(stri_extract_first_regex(LF$IDStraftat, ".{1}") == "9", "Strafrechtliche Nebengesetze", LF$StraftatGruppe )

### check
view(select(LF,StraftatGruppe, Straftat,IDStraftat ))

```


### 2.4 merge BKA tables into DF "BKA" for Analysis 
```{r}
# create new dataframe on the basis of the Dtaframe LF
### we use this table to build the analysis, since it is in a wide format

### colomn names
colnames(LF)

### keep only relevant variables
BKA <- select(LF, IDStraftat, Straftat, Bundesland,Jahr, AnErfFaelle, AnVersuche, TeilVersuche, AnAufkl, TeilAufkl)

### divide the dataframe by ID_Straftat and rejoin in wide format
T1 <- filter(BKA, IDStraftat =="------")
T2 <- filter(BKA, IDStraftat =="000000")
T3 <- filter(BKA, IDStraftat =="100000")
T4 <- filter(BKA, IDStraftat =="200000")
T5 <- filter(BKA, IDStraftat =="****00")
T6 <- filter(BKA, IDStraftat =="500000")
T7 <- filter(BKA, IDStraftat =="600000")
T8 <- filter(BKA, IDStraftat =="700000")

colnames(T1)[5:9] <- paste("StrIns", colnames(T1[,c(5:9)]), sep = "_")
colnames(T2)[5:9] <- paste("StrggLeben", colnames(T2[,c(5:9)]), sep = "_")
colnames(T3)[5:9] <- paste("StrggSexSb", colnames(T3[,c(5:9)]), sep = "_")
colnames(T4)[5:9] <- paste("StrggperFr", colnames(T4[,c(5:9)]), sep = "_")
colnames(T5)[5:9] <- paste("Dieb", colnames(T5[,c(5:9)]), sep = "_")
colnames(T6)[5:9] <- paste("VerFaelDel", colnames(T6[,c(5:9)]), sep = "_")
colnames(T7)[5:9] <- paste("SonstStr", colnames(T7[,c(5:9)]), sep = "_")
colnames(T8)[5:9] <- paste("StrNebGes", colnames(T8[,c(5:9)]), sep = "_")

T1[1:2] <- NULL  
T2[1:2] <- NULL  
T3[1:2] <- NULL  
T4[1:2] <- NULL  
T5[1:2] <- NULL  
T6[1:2] <- NULL  
T7[1:2] <- NULL  
T8[1:2] <- NULL  

BKA <- Reduce(inner_join, list(T1, T2, T3, T4, T5, T6, T7, T8 ))

### keep only the 16 Bundesländer
BKA <- subset(BKA, Bundesland != "Deut")

```

### 2.5 import SO tables

```{r}
BeschArOrt <- read_excel("BeschamArOrt.xlsx")
BeschWohnOrt <- read_excel("BeschWohnOrt.xlsx")
BevDeutAus <- read_excel("Bev_Deut_Aus.xlsx")
BodenFlsch <- read_excel("Bodenflaesche.xlsx")
ErwerbAbsc <- read_excel("ERwerbmitAbsc.xlsx")
Flsch <- read_excel("Flaesche.xlsx")
SGB <- read_excel("SGB.xlsx") 
Wahl <- read_excel("Wahl.xlsx")
Geburt <- read_excel("Geburt.xlsx")
Alter <-  read_excel("Alter.xlsx")
Raum <- read_excel("Raum.xlsx")
ErwbWZ <- read_excel("ErwbWZ.xlsx")

```

### 2.6 adjust SO tables

```{r}
# adjust tables:
### adjust table ErwerbAbsc
I <- filter(ErwerbAbsc, Abschluss == "Insgesamt" )
oB <- filter(ErwerbAbsc, Abschluss == "ohne Berufsabschluss" )
mA <- filter(ErwerbAbsc, Abschluss == "mit akademischem Abschluss" )
mB <- filter(ErwerbAbsc, Abschluss == "mit anerkanntem Berufsabschluss" )

I <- rename(I,c('Insgesamt'='ErwerbInsgesamt'))
oB <- rename(oB,c('Insgesamt'='ErwerbOhneBerAbsch'))
mA<- rename(mA,c('Insgesamt'='ErwerbMitAkaAbsch'))
mB <- rename(mB,c('Insgesamt'='ErwerbMitBerAbsch'))

I[3] <- NULL  
oB[3] <- NULL  
mA[3] <- NULL  
mB[3] <- NULL

ErwerbAbsc <- Reduce(inner_join, list(I, oB, mB,mA))


### adjust table Alter 
Alter <- subset(Alter, Alter != "Insgesamt")
Alter$AlterZahl <- as.numeric(gsub(".*?([0-9]+).*$", "\\1", Alter$Alter))
A18 <- filter(Alter, AlterZahl <= 19 )
A2530 <- filter(Alter, AlterZahl <= 31 & AlterZahl >= 25)

A18[2] <- NULL  
A18[4] <- NULL
A2530[2] <- NULL
A2530[4] <- NULL

A18 <- aggregate(A18$Bevölkerung, by=list(Bundesland=A18$Bundesland), FUN=sum)
A2530 <- aggregate(A2530$Bevölkerung, by=list(Bundesland=A2530$Bundesland), FUN=sum)

A18<- rename(A18,c('x'='bis18J'))
A2530 <- rename(A2530,c('x'='von25bis30J'))

Alter <- Reduce(inner_join, list(A18, A2530))
Alter$Jahr <- 2013

### adjust table ErwbWZ 
ErwbWZDienst <- filter(ErwbWZ, WZ == "Dienstleistungsbereiche" )
ErwbWZIns <- filter(ErwbWZ, WZ == "Insgesamt" )

ErwbWZDienst[2] <- NULL  
ErwbWZIns[2] <- NULL

ErwbWZDienst <- rename(ErwbWZDienst,c('Erwerbstätige'='ErwbWZDienst'))
ErwbWZIns <- rename(ErwbWZIns,c('Erwerbstätige'='ErwbWZIns'))

ErwbWZ <- Reduce(inner_join, list(ErwbWZDienst, ErwbWZIns))

```

### 2.7 merge SO tables into DF "SO" for the analysis
```{r}
LSO <- dplyr::left_join(BeschArOrt, BeschWohnOrt, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, BevDeutAus, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, BodenFlsch, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, ErwerbAbsc, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, Flsch, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, SGB, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, Wahl, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, Geburt, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, Alter, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, ErwbWZ, by=c("Bundesland", "Jahr"))
LSO <- dplyr::left_join(LSO, Raum, by=c("Bundesland", "Jahr"))

```

### 2.8 create new variables in the DF SO
```{r}
# reorder
LSO <- LSO %>% arrange(Bundesland, Jahr)
colnames(LSO)

#Wahlbeteiligung - gibt´s
LSO <- LSO%>%
  mutate("WahlBet" =  TeilWahlbeteiligung,
         "AusländerTeil"=AusländerIns/BevölkerungIns*100, 
         #Ausländeranteil
         "FertiliaetTeil"=Geburt/BevölkerungIns*100, 
         #Fertilität
         "FlshEinw"= BevölkerungIns/qkm, 
         #Wohnfläche per Einwohner in m²
         "SiedVerkFlschTeil" = (SiedlungIns + VerkehrIns)/BodenFlaescheIns*100,
         #Anteil der Siedlungs- und Verkehrsfläche
         "GrueneTeil" = GRÜNE/ZweitStimme*100,
         #Anteil der Stimmen für die Parteien Grüne 
         "FDPTeil" = FDP/ZweitStimme*100, 
         #Anteil der Stimmen für die Parteien FDP, 
         "LinkeTeil" = DIELINKE/ZweitStimme*100, 
         #Anteil der Stimmen für die Parteien Linke,
         "SGBXIITeil" = Leistungsempfaenger_SGBXII/BevölkerungIns*100,
         #Anteil der Arbeitslosengeld II-Empfänger
         "ErwerbMitAkaAbschTeil" = ErwerbMitAkaAbsch/ErwerbInsgesamt*100,
         #Anteil der Beschäftigten mit Hochschulabschluss
         "ErwerbDienstTeil" = as.numeric(ErwbWZDienst)/as.numeric(ErwbWZIns)*100,
         #Anteil der Beschäftigten in der Dienstleistungsbranche
         "WohnEinw" = BevölkerungIns/WohnINs,
         #Anzahl der Personen pro Wohnung
         "von25bis30JTeil" = von25bis30J/BevölkerungIns*100,
         # Anteil an 25- bis 30-jährigen
         "bis18JTeil" = bis18J/BevölkerungIns*100,
         #Anteil der Bevölkerung unter 18 Jahren
         "ZweiZimmerTeil" = `2Raeume`/WohnINs*100,
         #Anteil der Wohnungen mit einem oder zwei Zimmern
         "BeschAoWoTeil" =(BeschAmArbOrt/BeschamWohnOrt*100)-100
         #Anteil der Arbeits- in Vergleich zu Wohnortsbeschäftigten, 
         )

SO <- select(LSO, Jahr, Bundesland, WahlBet,AusländerTeil, FertiliaetTeil, FlshEinw,SiedVerkFlschTeil,  GrueneTeil,FDPTeil, LinkeTeil,  SGBXIITeil,ErwerbMitAkaAbschTeil, ErwerbDienstTeil, WohnEinw, von25bis30JTeil, bis18JTeil, ZweiZimmerTeil,BeschAoWoTeil )

```

### 2.9 save BKA; SO, LF, LSO
```{r}
saveRDS(LF2013, file="LF2013.rds")
saveRDS(LF2014, file="LF2014.rds")
saveRDS(LF2015, file="LF2015.rds")
saveRDS(LF2016, file="LF2016.rds")
saveRDS(LF2017, file="LF2017.rds")
saveRDS(LF2018, file="LF2018.rds")
saveRDS(LF2019, file="LF2019.rds")
saveRDS(LF2020, file="LF2020.rds")
saveRDS(BKA, file="BKA.rds")
saveRDS(SO, file="SO.rds")
saveRDS(LSO, file="LSO.rds")
saveRDS(LF, file="LF.rds")

rm(list = ls())

```


### 2.10 check und merge SO and BKA for the analysis

```{r}
# check the variable used to merge
### recall the dataframes 
BKA <- readRDS("BKA.rds")
SO <- readRDS("SO.rds")

### Bundesland
unique(BKA$Bundesland)==unique(SO$Bundesland)
unique(BKA$Bundesland)
unique(SO$Bundesland)

SO$Bundesland <- ifelse(SO$Bundesland == "Baden-Württemberg, Land",
                   "Baden-Württemberg", SO$Bundesland )

### Jahr 
unique(BKA$Jahr)==unique(SO$Jahr)

### join
Data <- Reduce(inner_join, list(SO, BKA))

### save 
saveRDS(Data, file="Data.rds")
```


```{r}
rm(list = ls())
```

# 3 Deskriptive Statistiks

In this section the Dataframes LF and LSO are used to get a better overview of the data and their distribution. 

```{r}
rm(list = ls())

LF2013 <- readRDS("LF2013.rds")
LF2014 <- readRDS("LF2014.rds")
LF2015 <- readRDS("LF2015.rds")
LF2016 <- readRDS("LF2016.rds")
LF2017 <- readRDS("LF2017.rds")
LF2018 <- readRDS("LF2018.rds")
LF2019 <- readRDS("LF2019.rds")
LF2020 <- readRDS("LF2020.rds")
LF <- readRDS("LF.rds")
```


### 3.1 Development over time and Länder

```{r}
colnames(LF)

# development of Bundesländer 
### the development of Straftaten-Insgesamt over the years for Deut 
DS0 <- LF%>%filter(Straftat == "Straftaten insgesamt" & Bundesland == "Deut")
GG0.1 <- ggplot(DS0, aes(Jahr, AnErfFaelle))+geom_line()+ylim(0, 7000000)+ ggtitle("Entwiklung der Straftaten insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Straftaten insgesamt")
GG0.1
GG0.2 <- ggplot(DS0, aes(Jahr, AnVersuche))+geom_line()+ylim(0, 550000)+ ggtitle("Entwiklung der Versuche insgesamtin Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Versuche insgesamt")
GG0.2
GG0.3 <- ggplot(DS0, aes(Jahr, AnAufkl))+geom_line()+ylim(0, 4500000)+ ggtitle("Entwiklung der aufgeklärten Fälle insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der aufgeklärten Fälle")
GG0.3
```

```{r}
###  for each Bundesland the development of Straftaten-Insgesamt over the years(with Deut and without Deut)

DS1.1 <- LF%>%filter(Straftat == "Straftaten insgesamt")
GG1.1 <- ggplot(DS1.1, aes(x=Jahr, y=AnErfFaelle, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Straftaten insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Straftaten insgesamt")
GG1.1

DS1.2 <- LF%>%filter(Straftat == "Straftaten insgesamt" & Bundesland != "Deut")
GG1.2 <- ggplot(DS1.2, aes(x=Jahr, y=AnErfFaelle, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Straftaten insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Straftaten insgesamt")
GG1.2
GG1.3 <- ggplot(DS1.2, aes(x=Jahr, y=AnErfFaelle, colour = TG_KG, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Straftaten insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Straftaten insgesamt")
GG1.3
GG1.4 <- ggplot(DS1.2, aes(x=Jahr, y=AnErfFaelle, colour = TG_KG, group=Bundesland))+ geom_line()+scale_color_manual(values = c('red','gray62','gray62','seagreen3', 'seagreen4'))+ ggtitle("Entwiklung der Straftaten insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Straftaten insgesamt")
GG1.4

```

```{r}
###  for each Bundesland the development of Versuche over the years(with Deut and without Deut)

DS2.1 <- LF%>%filter(Straftat == "Straftaten insgesamt")
GG2.1 <- ggplot(DS2.1, aes(x=Jahr, y=AnVersuche, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Versuche insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Versuche insgesamt")
GG2.1

DS2.2 <- LF%>%filter(Straftat == "Straftaten insgesamt" & Bundesland != "Deut")
GG2.2 <- ggplot(DS2.2, aes(x=Jahr, y=AnVersuche, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Versuche insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Versuche insgesamt")
GG2.2
GG2.3 <- ggplot(DS2.2, aes(x=Jahr, y=AnVersuche, colour = TG_KG, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Versuche insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Versuche insgesamt")
GG2.3
GG2.4 <- ggplot(DS2.2, aes(x=Jahr, y=AnVersuche, colour = TG_KG, group=Bundesland))+ geom_line()+scale_color_manual(values = c('red','gray62','gray62','seagreen3', 'seagreen4'))+ ggtitle("Entwiklung der Versuche insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Versuche insgesamt")
GG2.4
```

```{r}
###  for each Bundesland the development of Versuche over the years(with Deut and without Deut)

DS3.1 <- LF%>%filter(Straftat == "Straftaten insgesamt")
GG3.1 <- ggplot(DS3.1, aes(x=Jahr, y=TeilVersuche, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Versuche Anteil in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der Versuche insgesamt")
GG3.1

DS3.2 <- LF%>%filter(Straftat == "Straftaten insgesamt" & Bundesland != "Deut")
GG3.2 <- ggplot(DS3.2, aes(x=Jahr, y=TeilVersuche, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Versuche Anteil in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der Versuche insgesamt")
GG3.2
GG3.3 <- ggplot(DS3.2, aes(x=Jahr, y=TeilVersuche, colour = TG_KG, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Versuche Anteil in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der Versuche insgesamt")
GG3.3
GG3.4 <- ggplot(DS3.2, aes(x=Jahr, y=TeilVersuche, colour = TG_KG, group=Bundesland))+ geom_line()+scale_color_manual(values = c('red','gray62','gray62','seagreen3', 'seagreen4'))+ ggtitle("Entwiklung der Versuche Anteil in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der Versuche insgesamt")
GG3.4
```

```{r}
###  for each Bundesland the development of Erklärung over the years(with Deut and without Deut)
DS4.1 <- LF%>%filter(Straftat == "Straftaten insgesamt")
GG4.1 <- ggplot(DS4.1, aes(x=Jahr, y=AnAufkl, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der erklärten Fälle insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Zahl der erklärten Fälle insgesamt")
GG4.1

DS4.2 <- LF%>%filter(Straftat == "Straftaten insgesamt" & Bundesland != "Deut")
GG4.2 <- ggplot(DS4.2, aes(x=Jahr, y=AnAufkl, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der erklärten Fälle insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Zahl der erklärten Fälle insgesamt")
GG4.2
GG4.3 <- ggplot(DS4.2, aes(x=Jahr, y=AnAufkl, colour = TG_KG, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der erklärten Fälle insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Zahl der erklärten Fälle insgesamt")
GG4.3
GG4.4 <- ggplot(DS4.2, aes(x=Jahr, y=AnAufkl, colour = TG_KG, group=Bundesland))+ geom_line()+scale_color_manual(values = c('red','gray62','gray62','seagreen3', 'seagreen4'))+ ggtitle("Entwiklung der erklärten Fälle insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Zahl der erklärten Fälle insgesamt")
GG4.4
```

```{r}
###  for each Bundesland the development of Erklärung over the years(with Deut and without Deut)
DS5.1 <- LF%>%filter(Straftat == "Straftaten insgesamt")
GG5.1 <- ggplot(DS5.1, aes(x=Jahr, y=TeilAufkl, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Anteil der erklärten Fälle insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der erklärten Fälle insgesamt")
GG5.1

DS5.2 <- LF%>%filter(Straftat == "Straftaten insgesamt" & Bundesland !="Deut")
GG5.2 <- ggplot(DS5.2, aes(x=Jahr, y=TeilAufkl, colour = Bundesland, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Anteil der erklärten Fälle insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der erklärten Fälle insgesamt")
GG5.2
GG5.3 <- ggplot(DS5.2, aes(x=Jahr, y=TeilAufkl, colour = TG_KG, group=Bundesland))+ geom_line()+ ggtitle("Entwiklung der Anteil der erklärten Fälle insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der erklärten Fälle insgesamt")
GG5.3
GG5.4 <- ggplot(DS5.2, aes(x=Jahr, y=TeilAufkl, colour = TG_KG, group=Bundesland))+ geom_line()+scale_color_manual(values = c('red','gray62','gray62','seagreen3', 'seagreen4'))+ ggtitle("Entwiklung der Anteil der erklärten Fälle insgesamt in deutschen Bundesländer von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der erklärten Fälle insgesamt")
GG5.4

```


## 3.2 Development Straftaten

```{r}
# Straftaten for each Years:
S13 <- unique(LF2013$IDStraftat)
S14 <- unique(LF2014$IDStraftat)
S15 <- unique(LF2015$IDStraftat)
S16 <- unique(LF2016$IDStraftat)
S17 <- unique(LF2017$IDStraftat)
S18 <- unique(LF2018$IDStraftat)
S19 <- unique(LF2019$IDStraftat)
S20 <- unique(LF2020$IDStraftat)

# Number of Straftaten for each Years:
length(S13)
length(S14)
length(S15)
length(S16)
length(S17)
length(S18)
length(S19)
length(S20)

# compare the Straftaten for each year:
S <- intersect(intersect(intersect(intersect(intersect(intersect(intersect(S13, S14), S15), S16), S17), S18),S19), S20)

```

```{r}
# development of Straftaten grouped by Straftaten
### consider only the comulative Straftaten Gruppen and the sum of all of them (Straftaten insgesamt) - Diagram
DS6 <- LF%>%filter(Bundesland =="Deut")
DS6.1 <- DS6%>%filter(IDStraftat =="------"| 
                      IDStraftat =="000000"|  
                      IDStraftat =="100000"| 
                      IDStraftat =="200000"|  
                      IDStraftat =="****00"| 
                      IDStraftat =="500000"| 
                      IDStraftat =="600000"| 
                      IDStraftat =="700000")
GG6.1.1 <- ggplot(DS6.1, aes(x=Jahr, y=AnErfFaelle, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ ggtitle("Entwiklung der Straftaten insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Straftaten insgesamt ")
GG6.1.1

GG6.1.2 <- ggplot(DS6.1, aes(x=Jahr, y=AnVersuche, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ ggtitle("Entwiklung der Versuche insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Versuche insgesamt ")
GG6.1.2

GG6.1.3 <- ggplot(DS6.1, aes(x=Jahr, y=TeilVersuche, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ ggtitle("Entwiklung der Anteil der Versuche insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil  der Straftaten insgesamt ")
GG6.1.3

GG6.1.4 <- ggplot(DS6.1, aes(x=Jahr, y=AnAufkl, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ ggtitle("Entwiklung der erklärten Fälle insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der erklärten Fälle insgesamt ")
GG6.1.4

GG6.1.5 <- ggplot(DS6.1, aes(x=Jahr, y=TeilAufkl, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ ggtitle("Entwiklung der Anteil der erklärten Fälle insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der erklärten Fälle insgesamt ")
GG6.1.5


### consider only the comulative Straftaten Gruppen without the sum of all of them (Straftaten insgesamt) - Diagram
DS6.2  <- DS6%>%filter(IDStraftat =="000000"|  
                      IDStraftat =="100000"| 
                      IDStraftat =="200000"|  
                      IDStraftat =="****00"| 
                      IDStraftat =="500000"| 
                      IDStraftat =="600000"| 
                      IDStraftat =="700000")
GG6.2.1 <- ggplot(DS6.2, aes(x=Jahr, y=AnErfFaelle, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ggtitle("Entwiklung der Straftaten insgesamt insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Straftaten insgesamt ")
GG6.2.1

GG6.2.2 <- ggplot(DS6.2, aes(x=Jahr, y=AnVersuche, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ggtitle("Entwiklung der Versuche insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der Vesuche insgesamt ")
GG6.2.2

GG6.2.3 <- ggplot(DS6.2, aes(x=Jahr, y=TeilVersuche, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ggtitle("Entwiklung der Anteil der Versuche insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der Versuche insgesamt ")
GG6.2.3

GG6.2.4 <- ggplot(DS6.2, aes(x=Jahr, y=AnAufkl, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ggtitle("Entwiklung der Anzahl der erklärten Fälle insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anzahl der erklärten Fälle insgesamt ")
GG6.2.4

GG6.2.5 <- ggplot(DS6.2, aes(x=Jahr, y=TeilAufkl, colour = StraftatGruppe, group=IDStraftat))+ geom_line()+ ggtitle("Entwiklung der Anteil der erklärten Fälle insgesamt in Deutschland von 2013 bis 2020") +  xlab("Jahre") + ylab("Anteil der erklärten Fälle insgesamt ")
GG6.2.5

```

```{r}
### consider only the comulative Straftaten Gruppen and the sum of all of them (Straftaten insgesamt) - Table
colnames(DS6.1)

DS6.3.1 <- select(DS6.1, IDStraftat, Jahr, AnErfFaelle)
DS6.3.1 <-  reshape(DS6.3.1, idvar = "IDStraftat", timevar = "Jahr", direction = "wide")

DS6.3.2 <- select(DS6.1, IDStraftat, Jahr, AnVersuche)
DS6.3.2 <-  reshape(DS6.3.2, idvar = "IDStraftat", timevar = "Jahr", direction = "wide")

DS6.3.3 <- select(DS6.1, IDStraftat, Jahr, TeilVersuche)
DS6.3.3 <-  reshape(DS6.3.3, idvar = "IDStraftat", timevar = "Jahr", direction = "wide")

DS6.3.4 <- select(DS6.1, IDStraftat, Jahr, AnAufkl)
DS6.3.4 <-  reshape(DS6.3.4, idvar = "IDStraftat", timevar = "Jahr", direction = "wide")

DS6.3.5 <- select(DS6.1, IDStraftat, Jahr, TeilAufkl)
DS6.3.5 <-  reshape(DS6.3.5, idvar = "IDStraftat", timevar = "Jahr", direction = "wide")
```


# 4. Analyse

In this section the Dateframe Data, combined from SO and BKA, is used for the analysis and the hypothesis testing

```{r}
rm(list = ls())
Data <- readRDS("Data.rds")

```

### 5.1 check and adjust the dataframe to fit the analysis

```{r}

# sorted first by region and by time-period
Data <- Data %>% arrange(Bundesland, Jahr)

# A name (character-string) or number is provided as identifier for each region
### create a new variable which gives every Bundesland an ID. Starting with Bayern as 1 and ending with the regions without treatment from 9 to 16
unique(Data$Bundesland)
unique(Data$Jahr)
Data$IDbl <- NA
Data$IDbl <- ifelse(Data$Bundesland == "Bayern","1", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Brandenburg","2", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Sachsen-Anhalt","3", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Hamburg","4", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Hessen","5", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Niedersachsen","6", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Nordrhein-Westfalen","7", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Sachsen","8", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Bremen","9", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Baden-Württemberg","10", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Mecklenburg-Vorpommern","11", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Rheinland-Pfalz","12", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Saarland","13", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Berlin","14", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Schleswig-Holstein","15", Data$IDbl )
Data$IDbl <- ifelse(Data$Bundesland == "Thüringen","16", Data$IDbl )
Data$IDbl <- as.numeric(Data$IDbl)
 
# create new variables TG_CG2019, TG_CG2020
### these variables identify with the value 1 the Bundesländer which got the treatment and with the value 0 the ones which did not
Data["TG_CG2019"] <- NA
Data["TG_CG2020"] <- NA
Data$TG_CG2019 <- ifelse(Data$Bundesland == "Bayern","1", Data$TG_CG2019 )
Data$TG_CG2019 <- ifelse(
  Data$Bundesland == "Thüringen" |
  Data$Bundesland == "Schleswig-Holstein" | 
  Data$Bundesland == "Berlin","0", Data$TG_CG2019 )
Data$TG_CG2019 <- as.numeric(Data$TG_CG2019)

Data$TG_CG2020 <- ifelse(Data$Bundesland == "Bayern","1", Data$TG_CG2020 )
Data$TG_CG2020 <- ifelse(
  Data$Bundesland == "Thüringen" |
  Data$Bundesland == "Schleswig-Holstein" | 
  Data$Bundesland == "Berlin"|
  Data$Bundesland == "Saarland"|
  Data$Bundesland == "Rheinland-Pfalz"|
  Data$Bundesland == "Mecklenburg-Vorpommern"|
  Data$Bundesland == "Bremen"|
  Data$Bundesland == "Baden-Württemberg","0", Data$TG_CG2020 )
Data$TG_CG2020 <- as.numeric(Data$TG_CG2020)

# controlvariables 
### under all the listed social economic variables find the ones which have an effect on the dependent variables on the basis of data from 2013

### TO DO!!!!!


```

### 5.2 Analysis with Synthetic Control Methods in Comparative Case Studies

Data preparation

```{r}

# Datapreparation
### we prepare our Data in order to be able to use the main function synth(). IN this case we consider the Data from 2013 till 2019. Reasons for that are: more units in the pool of the CG and Corona crisis. 
Data <- as.data.frame(Data)
View(Data)
is.data.frame(Data)

dataprep.out <-dataprep(
                       foo =Data,
                       predictors = c("BeschAoWoTeil", "ErwerbMitAkaAbschTeil") ,
                       predictors.op = "mean",
                       time.predictors.prior = 2013:2019 ,
                       special.predictors = list(
                         list("WahlBet" ,seq(2013,2017,4), "mean"), 
                         list("AusländerTeil", 2013, "mean"), 
                         list("FertiliaetTeil", 2013, "mean"),
                         list("FlshEinw", 2013, "mean"),
                         list("SiedVerkFlschTeil", 2013, "mean"),
                         list("GrueneTeil", seq(2013,2017,4), "mean"),
                         list("FDPTeil", seq(2013,2017,4), "mean"),
                         list("LinkeTeil", seq(2013,2017,4), "mean"),
                         list("SGBXIITeil", 2013, "mean"),
                         list("ErwerbDienstTeil", 2013, "mean"),
                         list("WohnEinw", 2013, "mean"),
                         list("von25bis30JTeil", 2013, "mean"),
                         list("bis18JTeil", 2013, "mean"),
                         list("ZweiZimmerTeil", 2013, "mean")),
                       dependent = "StrIns_AnErfFaelle",
                       unit.variable = "IDbl",
                       unit.names.variable = "Bundesland",
                       time.variable = "Jahr",
                       treatment.identifier = 1,
                       controls.identifier = c(9:16),
                       time.optimize.ssr = 2013:2017,
                       time.plot = 2013:2019
                       )



```

Exploring the Data

```{r}
# Treatment group - mean of the controllvariables 
dataprep.out$X1
# Control group - mean of the controllvariables
dataprep.out$X0
# Treatment group - Dependent variable 
dataprep.out$Z1
# Control group - Dependent variable
dataprep.out$Z0
```


```{r}
### plots and tables 
```

```{r}
### placebo
```

### 5.3 Analysis with DID

```{r}
# experimantal analysis with DID
```

Check

